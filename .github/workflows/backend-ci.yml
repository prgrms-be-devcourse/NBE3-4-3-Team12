name: Backend CI # ê·¸ëƒ¥ ìž‘ì—… ì´ë¦„ íŠ¹ë³„í•œ ì´ìœ  ì—†ê³  Front CIì™€ êµ¬ë¶„ì„ ìœ„í•œ ì´ë¦„

on: # ì›Œí¬í”Œë¡œìš°ê°€ íŠ¸ë¦¬ê±°ë˜ëŠ” ì´ë²¤íŠ¸ë¥¼ ì •ì˜
  push:
    # íŠ¹ì • ë¸Œëžœì¹˜ì— í‘¸ì‰¬ë ë•Œ
    # feature/ ì´ëŸ°ì‹ìœ¼ë¡œ ê¸°ëŠ¥ê°œë°œì„ í•˜ê¸° ë•Œë¬¸ì— ì¶”ê°€í•¨
    # ë‹¤ë¥¸ ì´ë¦„ì˜  ìž‘ì—… ë¸Œëžœì¹˜ë¥¼ ì“°ì‹ ë‹¤ë©´ ê°œì¸ì ìœ¼ë¡œ ì¶”ê°€í•´ì£¼ë©´ ë  ê²ƒ ê°™ìŠµë‹ˆë‹¤. "" ì—†ì´ ë¸Œëžœì¹˜ ì´ë¦„ì„ ì¶”ê°€.
    branches: [ main , kotlin-migration, 'feature/*' ]
    paths:
      - 'backend/**'
      - '.github/workflows/**'  # ì›Œí¬í”Œë¡œìš° íŒŒì¼ ìžì²´ê°€ ë³€ê²½ë˜ì–´ë„ ì‹¤í–‰
  pull_request:
    branches: [ main ] # upstream master(ì—¬ê¸°ì„œëŠ” main)ì— prë‚ ë¦´ë•Œ
    paths:
      - 'backend/**'

jobs: #workflowì—ì„œ ì‹¤í–‰ ìž‘ì—…ë“¤ ëª¨ìŒ
  build:
    runs-on: ubuntu-latest # ì‹¤í–‰í™˜ê²½ ìµœì‹  ìš°ë¶„íˆ¬
    defaults: # ìž‘ì—… ë‚´ ëª¨ë“  ë‹¨ê³„ì— ì ìš©ë  ê¸°ë³¸ ì„¤ì •
      run: # ëª¨ë“  ëª…ë ¹ì–´ê°€ ì‹¤í–‰ë  ê¸°ë³¸ ë””ë ‰í† ë¦¬
        working-directory: ./backend

    # Redis ì„œë¹„ìŠ¤ ì¶”ê°€
    services:
      redis:
        image: redis
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps: # ìˆœì°¨ë¡œ ì‹¤í–‰
      - uses: actions/checkout@v3 # actions/checkout@v3ëŠ” GitHubì—ì„œ ì œê³µí•˜ëŠ” ê³µì‹ ì•¡ì…˜, ì €ìž¥ì†Œ ì½”ë“œë¥¼ ìž‘ì—… í™˜ê²½ìœ¼ë¡œ ê°€ì ¸ì˜µë‹ˆë‹¤.
      - name: Set up JDK 21
        uses: actions/setup-java@v3 # JDKë¥¼ ì„¤ì •(ë¯¸ë¦¬ ì œê³µ)
        with: # ë²„ì „ë“¤
          java-version: '21'
          distribution: 'temurin'

      - name: Cache Gradle packages
        uses: actions/cache@v3 # actions/cache@v3 ì•¡ì…˜ì„ ì‚¬ìš©í•˜ì—¬ ë¹Œë“œ ì†ë„ë¥¼ í–¥ìƒì‹œí‚¤ê¸° ìœ„í•´ ìºì‹±
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('backend/**/*.gradle*', 'backend/**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Create test configuration file
        run: |
          cat > src/main/resources/application-test.yml << EOF
          spring:
            datasource:
              url: jdbc:h2:mem:testdb;MODE=MySQL;
              driverClassName: org.h2.Driver
              username: sa
            jpa:
              hibernate:
                ddl-auto: create-drop
            security:
              oauth2:
                client:
                  registration:
                    kakao:
                      client-id: ${{ secrets.KAKAO_CLIENT_ID }}
                      redirect-uri: http://localhost:8080/auth/kakao/callback
                      authorization-grant-type: authorization_code
                      scope: profile_nickname,profile_image,account_email
                  provider:
                    kakao:
                      authorization-uri: https://kauth.kakao.com/oauth/authorize
                      token-uri: https://kauth.kakao.com/oauth/token
                      user-info-uri: https://kapi.kakao.com/v2/user/me
                      user-name-attribute: id
              jwt:
                secret-key: ${{ secrets.JWT_SECRET_KEY }}
                access-token:
                  expiration: 216000
                refresh-token:
                  expiration: 518400

          logging:
            level:
              org:
                springframework:
                  security: DEBUG

          KAKAO_LOGOUT_URL: https://kauth.kakao.com/oauth/logout
          KAKAO_LOGOUT_REDIRECT_URI: http://localhost:8080/auth/kakao/logout/callback
          CLIENT_BASE_URL: http://localhost:3000
          EOF

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build with Gradle
        run: ./gradlew build -x test

      - name: Run tests with environment variables
        run: ./gradlew test --info --stacktrace
        env:
          SPRING_PROFILES_ACTIVE: test
          SPRING_DATASOURCE_URL: jdbc:h2:mem:testdb;MODE=MySQL;
          SPRING_DATASOURCE_DRIVER_CLASS_NAME: org.h2.Driver
          SPRING_DATASOURCE_USERNAME: sa
          SPRING_JPA_HIBERNATE_DDL_AUTO: create-drop
          SPRING_DATA_REDIS_HOST: localhost
          SPRING_DATA_REDIS_PORT: 6379
          SPRING_SECURITY_JWT_SECRET_KEY: ${{ secrets.JWT_SECRET_KEY }}
          SPRING_SECURITY_JWT_ACCESS_TOKEN_EXPIRATION: 216000
          SPRING_SECURITY_JWT_REFRESH_TOKEN_EXPIRATION: 518400
          SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_KAKAO_CLIENT_ID: ${{ secrets.KAKAO_CLIENT_ID }}
          SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_KAKAO_REDIRECT_URI: http://localhost:8080/auth/kakao/callback
          SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_KAKAO_AUTHORIZATION_GRANT_TYPE: authorization_code
          SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_KAKAO_SCOPE: profile_nickname,profile_image,account_email
          SPRING_SECURITY_OAUTH2_CLIENT_PROVIDER_KAKAO_AUTHORIZATION_URI: https://kauth.kakao.com/oauth/authorize
          SPRING_SECURITY_OAUTH2_CLIENT_PROVIDER_KAKAO_TOKEN_URI: https://kauth.kakao.com/oauth/token
          SPRING_SECURITY_OAUTH2_CLIENT_PROVIDER_KAKAO_USER_INFO_URI: https://kapi.kakao.com/v2/user/me
          SPRING_SECURITY_OAUTH2_CLIENT_PROVIDER_KAKAO_USER_NAME_ATTRIBUTE: id
          LOGGING_LEVEL_ORG_SPRINGFRAMEWORK_SECURITY: DEBUG
          KAKAO_LOGOUT_URL: https://kauth.kakao.com/oauth/logout
          KAKAO_LOGOUT_REDIRECT_URI: http://localhost:8080/auth/kakao/callback/
          CLIENT_BASE_URL: http://localhost:3000

      # JaCoCo í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ë³´ê³ ì„œ ìƒì„±
      - name: Generate JaCoCo Test Coverage Report
        run: ./gradlew jacocoTestReport

      # í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ê²€ì¦
      - name: Verify Test Coverage
        run: ./gradlew jacocoTestCoverageVerification || true  # ì»¤ë²„ë¦¬ì§€ê°€ ë‚®ì•„ë„ ë¹Œë“œ ì‹¤íŒ¨í•˜ì§€ ì•ŠìŒ

      - name: Test with Gradle
        run: ./gradlew test
      # ì»¤ë²„ë¦¬ì§€ ë³´ê³ ì„œë¥¼ ì•„í‹°íŒ©íŠ¸ë¡œ ì—…ë¡œë“œ
      - name: Upload JaCoCo Test Coverage Report
        uses: actions/upload-artifact@v4
        with:
          name: jacoco-report
          path: backend/build/reports/jacoco/test/html/

      # ì„ íƒ ì‚¬í•­: ì»¤ë²„ë¦¬ì§€ ê²°ê³¼ë¥¼ PR ì½”ë©˜íŠ¸ì— ì¶”ê°€ (ì„ íƒì )
      - name: Comment Test Coverage on PR
        if: github.event_name == 'pull_request'
        uses: madrapps/jacoco-report@v1.3
        with:
          paths: backend/build/reports/jacoco/test/jacocoTestReport.xml
          token: ${{ secrets.GITHUB_TOKEN }}
          min-coverage-overall: 40
          min-coverage-changed-files: 60
          title: 'ðŸ“Š ì»¨íŠ¸ë¡¤ëŸ¬ í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸'